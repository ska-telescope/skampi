---
# ################################################
# # SKA Mid CI Stages
# ################################################

# TODO: Uncomment this
#mid-test:
#  stage: test
#  variables:
#    CONFIG: mid
#    DEPLOYMENT_CONFIGURATION: "ska-$CONFIG"
#    K8S_CHART: "$DEPLOYMENT_CONFIGURATION"
#    HELM_RELEASE: "test-$CONFIG-$CI_JOB_ID"
#    KUBE_NAMESPACE: "ci-$CI_PROJECT_NAME-$CI_JOB_ID-$CONFIG"
#    KUBE_NAMESPACE_SDP: "ci-$CI_PROJECT_NAME-$CI_JOB_ID-$CONFIG-sdp"
#    SERVICE_ACCOUNT: "ci-svc-$CI_PROJECT_NAME-$CI_JOB_ID"
#    ARCHIVER_DBNAME: "${CONFIG}_archiver_db"
#    DISABLE_MAINTAIN_ON: "True"
#    OET_INGRESS_ENABLED: "true"
#    TEST_ENV: "BUILD_IN"
#    ATTR_SYNCH_ENABLED_GLOBALLY: "True"
#    EXIT_AT_FAIL: "false"
#    CAPTURE_LOGS: "True"
#    DEBUG_ENTRYPOINT: "True"
#    DEBUG_ENTRYPOINT_EXTENDED: "True"
#    LIVE_LOGGING_EXTENDED: "True"
#    COUNT: 1
#  extends:
#    - .tags_default
#    - .set_dbname
#  script:
#    - !reference [.deploy_chart_before, before_script]
#    - !reference [.test_deployment, script]
#  environment:
#    name: test/ska-$CONFIG-$CI_COMMIT_REF_SLUG
#    kubernetes:
#      # This repetition is needed for gitlab to parse the namespace correctly
#      namespace: $KUBE_NAMESPACE
#    url: "http://$INGRESS_HOST/$KUBE_NAMESPACE/taranta"
#  artifacts:
#    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
#    paths:
#      - "build/"
#    reports:
#      junit: build/report.xml
#    when: always
#  retry: 1
#  rules: # TODO: Remove this
#    - when: manual
#
#clean-mid-test:
#  stage: clean_test_env
#  variables:
#    CONFIG: mid
#    DEPLOYMENT_CONFIGURATION: "ska-$CONFIG"
#    K8S_CHART: "$DEPLOYMENT_CONFIGURATION"
#    HELM_RELEASE: "test-$CONFIG-$CI_JOB_ID"
#    KUBE_NAMESPACE: "ci-$CI_PROJECT_NAME-$CI_JOB_ID-$CONFIG"
#    KUBE_NAMESPACE_SDP: "ci-$CI_PROJECT_NAME-$CI_JOB_ID-$CONFIG-sdp"
#    SERVICE_ACCOUNT: "ci-svc-$CI_PROJECT_NAME-$CI_JOB_ID"
#    ARCHIVER_DBNAME: "${CONFIG}_archiver_db"
#    COUNT: 1
#    DISABLE_MAINTAIN_ON: "True"
#    TEST_ENV: "BUILD_OUT"
#    TEL: mid
#  extends:
#    - .set_dbname
#    - .tags_default
#  script:
#    - !reference [.uninstall_chart_after, after_script]
#  when: always
#  environment:
#    name: test/ska-$CONFIG-$CI_COMMIT_REF_SLUG
#    kubernetes:
#      # This repetition is needed for gitlab to parse the namespace correctly
#      namespace: $KUBE_NAMESPACE
#    url: "http://$INGRESS_HOST/$KUBE_NAMESPACE/taranta"
#  allow_failure: true
#  rules: # TODO: Remove this
#    - when: manual

# Mid on-demand deployment
mid_on_demand_deploy:
  stage: build
  variables:
    CONFIG: mid
    DEPLOYMENT_CONFIGURATION: "ska-$CONFIG"
    K8S_CHART: "$DEPLOYMENT_CONFIGURATION"
    HELM_RELEASE: "test-$CONFIG-$CI_JOB_ID"
    KUBE_NAMESPACE: "ci-$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG-$CONFIG"
    KUBE_NAMESPACE_SDP: "ci-$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG-$CONFIG-sdp"
    SERVICE_ACCOUNT: "ci-svc-$CI_PROJECT_NAME-$CI_COMMIT_REF_SLUG"
    ARCHIVER_DBNAME: "${CONFIG}_archiver_db"
    OET_INGRESS_ENABLED: "true"
  extends:
    - .tags_default
    - .set_dbname
    - .deploy_chart_before
  script:
    - make skampi-links
  environment:
    name: test/ska-$CONFIG-$CI_COMMIT_REF_SLUG
    kubernetes:
      # This repetition is needed for gitlab to parse the namespace correctly
      namespace: $KUBE_NAMESPACE
    url: "http://$INGRESS_HOST/$KUBE_NAMESPACE/taranta"
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - "build/"
    reports:
      junit: build/report.xml
  when: manual
  allow_failure: true

# Mid integration

.mid-integration-config:
  variables:
    CONFIG: mid
    DEPLOYMENT_CONFIGURATION: ska-$CONFIG
    K8S_CHART: $DEPLOYMENT_CONFIGURATION
    KUBE_NAMESPACE: integration-$CI_PROJECT_NAME-$CONFIG
    KUBE_NAMESPACE_SDP: integration-$CI_PROJECT_NAME-$CONFIG-sdp
    HELM_RELEASE: $CONFIG
    SERVICE_ACCOUNT: integration-$CONFIG-sa
    ARCHIVER_DBNAME: integration-$CONFIG-archiver_db
    INGRESS_HOST: k8s.stfc.skao.int
    KEEP_NAMESPACE: "true"
  environment:
    name: integration-$CI_PROJECT_NAME-$CONFIG

mid-deploy-integration:
  extends:
    - deploy-integration
    - .mid-integration-config
  variables:
    KUBE_NAMESPACE: integration-$CI_PROJECT_NAME-$CONFIG
  after_script:
    - make skampi-links
  environment:
    name: integration-$CI_PROJECT_NAME-$CONFIG
    on_stop: mid-stop-integration
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - "build/"
    reports:
      junit: build/report.xml
  rules:
    - when: manual # TODO: Remove this
    - if: $CI_COMMIT_TAG

mid-info-integration:
  extends:
    - info-integration
    - .mid-integration-config
  variables:
    KUBE_NAMESPACE: integration-$CI_PROJECT_NAME-$CONFIG
  environment:
    name: integration-$CI_PROJECT_NAME-$CONFIG
  rules:
    - when: manual # TODO: Remove this
    - if: $CI_COMMIT_TAG
      when: manual

mid-stop-integration:
  extends:
    - stop-integration
    - .mid-integration-config
  needs:
    - mid-deploy-integration
  variables:
    KUBE_NAMESPACE: integration-$CI_PROJECT_NAME-$CONFIG
  environment:
    name: integration-$CI_PROJECT_NAME-$CONFIG
  rules:
    - when: manual # TODO: Remove this
    - if: $CI_COMMIT_TAG
      when: manual

mid-redeploy-integration:
  extends:
    - redeploy-integration
    - .mid-integration-config
  variables:
    KUBE_NAMESPACE: integration-$CI_PROJECT_NAME-$CONFIG
  environment:
    name: integration-$CI_PROJECT_NAME-$CONFIG
  rules:
    - when: manual # TODO: Remove this
    - if: $CI_COMMIT_TAG
      when: manual

## Mid staging

.mid-staging-config:
  variables:
    CONFIG: mid
    DEPLOYMENT_CONFIGURATION: ska-$CONFIG
    K8S_CHART: $DEPLOYMENT_CONFIGURATION
    KUBE_NAMESPACE: staging-$CI_PROJECT_NAME-$CONFIG
    KUBE_NAMESPACE_SDP: staging-$CI_PROJECT_NAME-$CONFIG-sdp
    HELM_RELEASE: $CONFIG
    SERVICE_ACCOUNT: staging-$CONFIG-sa
    ARCHIVER_DBNAME: staging-$CONFIG-archiver_db
    INGRESS_HOST: k8s.stfc.skao.int
    KEEP_NAMESPACE: "true"
  environment:
    name: staging-$CI_PROJECT_NAME-$CONFIG

mid-deploy-staging:
  extends:
    - deploy-staging
    - .mid-staging-config
  needs:
    - mid-deploy-integration
  variables:
    KUBE_NAMESPACE: staging-$CI_PROJECT_NAME-$CONFIG
  after_script:
    - make skampi-links
  environment:
    name: staging-$CI_PROJECT_NAME-$CONFIG
    on_stop: mid-stop-staging
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - "build/"
    reports:
      junit: build/report.xml
  rules:
    - when: manual # TODO: Remove this
    - if: $CI_COMMIT_TAG

mid-info-staging:
  extends:
    - info-staging
    - .mid-staging-config
  variables:
    KUBE_NAMESPACE: staging-$CI_PROJECT_NAME-$CONFIG
  environment:
    name: staging-$CI_PROJECT_NAME-$CONFIG
  rules:
    - when: manual # TODO: Remove this
    - if: $CI_COMMIT_TAG
      when: manual

mid-stop-staging:
  extends:
    - stop-staging
    - .mid-staging-config
  needs:
    - mid-deploy-staging
  variables:
    KUBE_NAMESPACE: staging-$CI_PROJECT_NAME-$CONFIG
  environment:
    name: staging-$CI_PROJECT_NAME-$CONFIG
  rules:
    - when: manual # TODO: Remove this
    - if: $CI_COMMIT_TAG
      when: manual

mid-redeploy-staging:
  extends:
    - redeploy-staging
    - .mid-staging-config
  variables:
    KUBE_NAMESPACE: staging-$CI_PROJECT_NAME-$CONFIG
  environment:
    name: staging-$CI_PROJECT_NAME-$CONFIG
  rules:
    - when: manual # TODO: Remove this
    - if: $CI_COMMIT_TAG
      when: manual
