# ################################################
# # Common CI Stages
# ################################################

# must have K8S_CHART set correctly
.deploy_chart_before:
  before_script:
  - make k8s-install-chart
  - kubectl get all,pv,pvc,ingress -n $KUBE_NAMESPACE
  - make skampi-wait-all

.deploy_chart:
  script:
  - !reference [.deploy_chart_before, before_script]

.test_deployment:
  script:
    - echo $CI_JOB_NAME - $CI_JOB_STAGE
    - bash scripts/gitlab_section.sh vars "Make config dump" make vars
    - echo "############## Running Skampi core tests"
    - make k8s-test
    - echo "############## Running Skampi component tests"
    - make skampi-component-tests
    - echo "############## Build Output"
    - find ./build
    - echo "############## EXTRA MAKE VARS OUTPUT"
    - make skampi-vars
    - echo "#####################################"

.deploy_chart_and_test_integration:
  script:
  - !reference [.deploy_chart_before, before_script]
  - !reference [.test_deployment, script]
  - |
    if [ -f build/cucumber.json ]; then
    bash scripts/gitlab_section.sh install_skallop "Installing Skallop Requirements" pip3 install -U "ska-ser-skallop>=$SKALLOP_VERSION"  --extra-index-url https://artefact.skao.int/repository/pypi-internal/simple
    /usr/local/bin/xtp-xray-upload -f build/cucumber.json -i test-exec.json -v
    fi

.uninstall_chart_before:
  before_script:
    - echo $CI_JOB_NAME - $CI_JOB_STAGE
    - bash scripts/gitlab_section.sh vars "Make config dump" make vars
    - make k8s-uninstall-chart || true
    - kubectl -n $KUBE_NAMESPACE delete pods,svc,daemonsets,deployments,replicasets,statefulsets,cronjobs,jobs,ingresses,configmaps --all --ignore-not-found
    - kubectl -n $KUBE_NAMESPACE_SDP delete pods,svc,daemonsets,deployments,replicasets,statefulsets,cronjobs,jobs,ingresses,configmaps --all --ignore-not-found
    - make k8s-delete-namespace
    - make delete-sdp-namespace

.uninstall_chart:
  script:
    - !reference [.uninstall_chart_before, before_script]

.uninstall_chart_after:
  after_script:
    - !reference [.uninstall_chart_before, before_script]
    - |
      if [ -f build/cucumber.json ]; then
      bash scripts/gitlab_section.sh install_skallop "Installing Skallop Requirements" pip3 install -U "ska-ser-skallop>=$SKALLOP_VERSION"  --extra-index-url https://artefact.skao.int/repository/pypi-internal/simple
      /usr/local/bin/xtp-xray-upload -f build/cucumber.json -i test-exec.json -v
      fi

.destroy_deploy_chart_before:
  before_script:
  - !reference [.uninstall_chart_before, before_script]
  - !reference [.deploy_chart_before, before_script]

.deploy_test:
  stage: test
  extends:
    - .destroy_deploy_chart_before
    - .test_deployment
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - "build/"
    reports:
      junit: build/report.xml
    when: always

## Not currently used!!!
.deploy_test_destroy:
  stage: test
  extends:
    - .deploy_chart_before
    - .test_deployment
    - .uninstall_chart_after
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - "build/"
    reports:
      junit: build/report.xml
    when: always
