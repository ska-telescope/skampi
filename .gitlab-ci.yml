image: $SKA_K8S_TOOLS_DEPLOY_IMAGE

variables:
  MINIKUBE: "false"
  VALUES: "pipeline.yaml"
  CHARTS_TO_PUBLISH: ska-low ska-mid ska-landingpage
  INGRESS_HOST: "k8s.stfc.skao.int"
  GIT_SUBMODULE_STRATEGY: recursive
  SKALLOP_VERSION: "2.12.1"
  K8S_TEST_IMAGE_TO_TEST: artefact.skao.int/ska-ser-skallop:$SKALLOP_VERSION
  KUBE_HOST: 192.168.99.222
  KUBE_BRANCH: $CI_JOB_ID
  DOMAIN: "branch"

stages:
  - build
  - test
  - lint
  - publish
  - deploy_integration
  - clean_integration
  - pages
  - release
  - deploy_staging
  - clean_staging

# Globally reused tags declaration for jobs
.tags_default:
  tags:
    - k8srunner

# See: https://docs.gitlab.com/ee/ci/yaml/includes.html
include:
  # Common template components
  - local: "/.gitlab/ci/common.gitlab-ci.yml"
  # temp comment out - only test mid
  # # All SKA Low stages
  - local: "/.gitlab/ci/ska-low.gitlab-ci.yml"
  # All SKA Mid stages
  - local: "/.gitlab/ci/ska-mid.gitlab-ci.yml"

  # Python tests, directly run
  - project: "ska-telescope/templates-repository"
    file: "gitlab-ci/includes/python-test.gitlab-ci.yml"

  # Helm Charts
  - project: "ska-telescope/templates-repository"
    file: "gitlab-ci/includes/helm-chart.gitlab-ci.yml"

  # Docs - only build as stress tests use 'public'
  - project: "ska-telescope/templates-repository"
    file: "gitlab-ci/includes/docs-build.gitlab-ci.yml"

  # release steps
  - project: "ska-telescope/templates-repository"
    file: "gitlab-ci/includes/release.gitlab-ci.yml"

  # .post steps
  - project: "ska-telescope/templates-repository"
    file: "gitlab-ci/includes/finaliser.gitlab-ci.yml"

# overide the image because we need Python 3.9+ and a unique Namespace
# in the python-test
python-test:
  image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
  variables:
    CLUSTER_TEST_NAMESPACE: ci-$CI_JOB_ID-infra
    PYTHON_VARS_AFTER_PYTEST: -m infra
  after_script:
    - make k8s-delete-namespace KUBE_NAMESPACE=$CLUSTER_TEST_NAMESPACE
    - find ./build
    - |
      echo "Processing XRay uploads"
      if [ -n "$(ls -A build/cucumber*.json 2>/dev/null)" ]; then
        bash scripts/gitlab_section.sh install_skallop "Installing Skallop Requirements" pip3 install -U "ska-ser-skallop>=$SKALLOP_VERSION"  --extra-index-url https://artefact.skao.int/repository/pypi-internal/simple
      fi
      for cuke in  build/cucumber*.json
      do
        echo "Processing XRay upload of: $cuke"
        /usr/local/bin/xtp-xray-upload -f $cuke -i tests/test-exec.json -v
      done
  environment:
    name: test/$CI_COMMIT_REF_SLUG-cluster
    kubernetes:
      namespace: $CLUSTER_TEST_NAMESPACE
