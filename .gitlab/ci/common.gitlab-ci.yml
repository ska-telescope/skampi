# ################################################
# # Common CI Stages
# ################################################

.deploy_definition:
  before_script:
  - make k8s-install-chart K8S_CHART=$DEPLOYMENT_CONFIGURATION
  - kubectl get all,pv,pvc,ingress -n $KUBE_NAMESPACE
  - make k8s-wait

.test_definition:
  script:
    - echo $CI_JOB_NAME - $CI_JOB_STAGE
    - bash scripts/gitlab_section.sh vars "Make config dump" make vars
    - make k8s-test
    - echo "############## Build Output"
    - find ./build
    - echo "############## EXTRA MAKE VARS OUTPUT"
    - make vars
    - echo "#####################################"

.uninstall_definition:
  after_script:
    - echo $CI_JOB_NAME - $CI_JOB_STAGE
    - bash scripts/gitlab_section.sh vars "Make config dump" make vars
    - make k8s-uninstall-chart
    - kubectl -n $KUBE_NAMESPACE delete pods,svc,daemonsets,deployments,replicasets,statefulsets,cronjobs,jobs,ingresses,configmaps --all
    - kubectl -n $KUBE_NAMESPACE_SDP delete pods,svc,daemonsets,deployments,replicasets,statefulsets,cronjobs,jobs,ingresses,configmaps --all
    - make k8s-delete-namespace
    - make delete-sdp-namespace
    - |
      if [ -f build/cucumber.json ]; then
      bash scripts/gitlab_section.sh install_skallop "Installing Skallop Requirements" pip3 install -U "ska-ser-skallop>=$SKALLOP_VERSION"  --extra-index-url https://artefact.skao.int/repository/pypi-internal/simple
      /usr/local/bin/xtp-xray-upload -f build/cucumber.json -i test-exec.json -v
      fi

.deploy_test_destroy_definition:
  stage: test
  extends:
    - .deploy_definition
    - .test_definition
    - .uninstall_definition
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - "build/"
    reports:
      junit: build/report.xml
    when: always

